<!-- åŠŸå¾·è®¡æ•°å™¨ç»„ä»¶ - åˆå§‹éšè—ï¼Œè§£é”åæ˜¾ç¤º -->
<div id="muyu-container" style="display: none;">
  <div id="muyu-widget">
    <div id="merit-counter"><span id="merit-count">0</span></div>
  </div>
</div>

<!-- å¤´åƒç‚¹å‡»åŒºåŸŸçš„å¼¹å‡ºæ–‡å­—å®¹å™¨ -->
<div id="avatar-merit-popup"></div>

<style>
#muyu-container {
  position: absolute;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
}

#muyu-widget {
  position: relative;
  text-align: center;
  background: rgba(255, 255, 255, 0.95);
  padding: 8px 20px;
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  white-space: nowrap;
}

#muyu-widget:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
}

#merit-counter {
  font-size: 18px;
  font-weight: bold;
  color: #D4AF37;
  text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
}

#merit-count {
  color: #FF6B35;
  font-size: 24px;
}

/* å¤´åƒç‚¹å‡»æ•ˆæœ */
.avatar-wrapper {
  cursor: pointer;
  transition: transform 0.2s ease;
  position: relative;
  margin-left: auto;
  margin-right: auto;
}

/* ç¡®ä¿åå­—å®¹å™¨å±…ä¸­ */
.avatar-wrapper + .space-y-3 {
  text-align: center;
  width: 100%;
}

.avatar-wrapper + .space-y-3 h1 {
  text-align: center;
}

.avatar-wrapper:hover {
  transform: scale(1.05);
}

.avatar-wrapper:active {
  animation: avatarKnock 0.3s ease;
}

@keyframes avatarKnock {
  0%, 100% { transform: scale(1) rotate(0deg); }
  25% { transform: scale(0.95) rotate(-3deg); }
  75% { transform: scale(0.95) rotate(3deg); }
}

/* å¤´åƒä¸Šçš„å¼¹å‡ºæ–‡å­—å®¹å™¨ */
#avatar-merit-popup {
  position: fixed;
  pointer-events: none;
  z-index: 10000;
}

.merit-text {
  position: absolute;
  font-size: 24px;
  font-weight: bold;
  color: #FFD700;
  text-shadow:
    0 0 10px rgba(255, 215, 0, 0.8),
    2px 2px 4px rgba(0, 0, 0, 0.3);
  animation: floatUp 1.5s ease-out forwards;
  white-space: nowrap;
}

@keyframes floatUp {
  0% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  50% {
    opacity: 1;
    transform: translateY(-50px) scale(1.2);
  }
  100% {
    opacity: 0;
    transform: translateY(-100px) scale(0.8);
  }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  #muyu-container {
    top: -50px;
  }

  #muyu-widget {
    padding: 6px 16px;
  }

  #merit-counter {
    font-size: 16px;
  }

  #merit-count {
    font-size: 20px;
  }
}
</style>

<script>
let globalMeritCount = 0; // å…¨å±€åŠŸå¾·å€¼ï¼ˆæ‰€æœ‰ç”¨æˆ·çš„æ€»å’Œï¼‰

const meritPhrases = [
  'åŠŸå¾·+1 âœ¨',
  'é¡¶åˆŠé¢„å®šï¼ğŸš€',
  'è®ºæ–‡ä¸Šå²¸ï¼ğŸ‰',
  'é¡¹ç›®åˆ°æ‰‹ ğŸ’°',
  'å¼€æºå¤§å‰ ğŸ’»',
  'è¢«å¤¸äº†ï¼ğŸŒ·',
  'å®éªŒæˆåŠŸï¼ğŸ§ª',
  'ç­”è¾©è¿‡è¿‡è¿‡ï¼ğŸ‘',
  'å¥–å­¦é‡‘Getï¼ğŸ¤‘',
  'äº¤æµæ„‰å¿« ğŸ¤',
  'çªç ´è¾¾æˆï¼ğŸ’¡',
  'æ•°æ®æ”¶å·¥ ğŸ“Š',
  'æŸ¥é‡ç¨³äº† âœ…',
  'æ–°æ–‡å‘è¡¨ï¼ğŸ“„',
  'ä¸“åˆ©åˆ°æ‰‹ âš–ï¸',
  'åˆä½œæ„‰å¿« ğŸ¥³',
  'å‘è¨€ç²¾å½© ğŸ¤',
  'æ°›å›´è¶…å¥½ ğŸ’¯',
  'å¯¼å¸ˆç‚¹èµ ğŸ˜„',
  'æ–¹å‘æ˜ç¡® ğŸ§­'
];

// CountAPI é…ç½® - ç”¨äºå…¨å±€è®¡æ•°
const COUNTAPI_NAMESPACE = 'y-xvan';
const COUNTAPI_KEY = 'muyu-merit-total';

// ä» CountAPI è·å–å…¨å±€åŠŸå¾·å€¼
async function loadGlobalMeritCount() {
  try {
    const response = await fetch(`https://api.countapi.xyz/get/${COUNTAPI_NAMESPACE}/${COUNTAPI_KEY}`);
    const data = await response.json();
    if (data.value !== undefined) {
      globalMeritCount = data.value;
      updateMeritDisplay();
    }
  } catch (error) {
    console.log('Failed to load global merit count:', error);
    // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºæœ¬åœ°å¤‡ä»½å€¼
    const localBackup = localStorage.getItem('globalMeritBackup');
    if (localBackup) {
      globalMeritCount = parseInt(localBackup);
      updateMeritDisplay();
    }
  }
}

// æ›´æ–°æ˜¾ç¤º
function updateMeritDisplay() {
  const meritCountEl = document.getElementById('merit-count');
  if (meritCountEl) {
    // ä½¿ç”¨åƒä½åˆ†éš”ç¬¦æ ¼å¼åŒ–æ•°å­—ï¼Œè®©å¤§æ•°å­—æ›´æ˜“è¯»
    meritCountEl.textContent = globalMeritCount.toLocaleString();
  }
}

// é¡µé¢åŠ è½½æ—¶è·å–å…¨å±€è®¡æ•°
loadGlobalMeritCount();

// ç­‰å¾… DOM åŠ è½½å®Œæˆåç»‘å®šå¤´åƒç‚¹å‡»äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
  const avatar = document.querySelector('.avatar-wrapper');

  if (avatar) {
    // å°†åŠŸå¾·è®¡æ•°å™¨ç§»åˆ°å¤´åƒå®¹å™¨ä¸­
    const meritContainer = document.getElementById('muyu-container');
    avatar.style.position = 'relative';
    avatar.appendChild(meritContainer);

    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    avatar.addEventListener('click', function(e) {
      knockAvatar(e);
    });
  }
});

async function knockAvatar(event) {
  // ä¹è§‚æ›´æ–°ï¼šç«‹å³å¢åŠ æ˜¾ç¤ºçš„åŠŸå¾·å€¼
  globalMeritCount++;
  updateMeritDisplay();

  // æ˜¾ç¤ºéšæœºåŠŸå¾·æ–‡å­—ï¼ˆåœ¨å¤´åƒä½ç½®ï¼‰
  showMeritTextAtAvatar(event);

  // è°ƒç”¨è§£é”ç³»ç»Ÿå¢åŠ ä¸ªäººç‚¹å‡»æ¬¡æ•°ï¼ˆç”¨äºæˆå°±è§£é”ï¼‰
  if (typeof window.incrementMuyuClicks === 'function') {
    window.incrementMuyuClicks();
  }

  // å¼‚æ­¥æ›´æ–°å…¨å±€è®¡æ•°åˆ°æœåŠ¡å™¨
  try {
    const response = await fetch(`https://api.countapi.xyz/hit/${COUNTAPI_NAMESPACE}/${COUNTAPI_KEY}`);
    const data = await response.json();
    if (data.value !== undefined) {
      globalMeritCount = data.value;
      updateMeritDisplay();
      // ä¿å­˜å¤‡ä»½åˆ° localStorage
      localStorage.setItem('globalMeritBackup', globalMeritCount);
    }
  } catch (error) {
    console.log('Failed to update global merit count:', error);
    // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œä¿å­˜æœ¬åœ°å¤‡ä»½
    localStorage.setItem('globalMeritBackup', globalMeritCount);
  }
}

function showMeritTextAtAvatar(event) {
  const popup = document.getElementById('avatar-merit-popup');
  const text = document.createElement('div');
  text.className = 'merit-text';

  // éšæœºé€‰æ‹©åŠŸå¾·è¯­å¥
  const phrase = meritPhrases[Math.floor(Math.random() * meritPhrases.length)];
  text.textContent = phrase;

  // è·å–å¤´åƒçš„ä½ç½®
  const avatar = document.querySelector('.avatar-wrapper');
  const rect = avatar.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;

  // éšæœºåç§»ä½ç½®ï¼Œé¿å…é‡å 
  const randomX = (Math.random() - 0.5) * 100;
  const randomY = (Math.random() - 0.5) * 60;

  text.style.left = (centerX + randomX) + 'px';
  text.style.top = (centerY + randomY) + 'px';

  popup.appendChild(text);

  // 1.5ç§’åç§»é™¤å…ƒç´ 
  setTimeout(() => {
    if (popup.contains(text)) {
      popup.removeChild(text);
    }
  }, 1500);
}

</script>
