<!-- ç‹—çªåœ†åœˆæŒ‰é’® - åˆå§‹éšè— -->
<div id="dog-house-button" style="display: none;">Release</div>

<!-- è·Ÿéšé¼ æ ‡çš„å°ç‹—ç»„ä»¶ -->
<div id="fish-follower" style="display: none;">
  <div class="dog-sprite"></div>
</div>

<!-- ç‹—ç‹—çŠ¶æ€èœå• -->
<div id="dog-status-menu">
  <button class="close-btn" onclick="closeDogMenu()">Ã—</button>
  <h3>ğŸ• Menu</h3>

  <div class="status-item">
    <div class="status-icon">ğŸ˜Š</div>
    <div class="status-content">
      <div class="status-label">Mood</div>
      <div class="status-bar">
        <div class="status-bar-fill mood" id="mood-bar"></div>
        <div class="status-value" id="mood-value">100%</div>
      </div>
    </div>
  </div>

  <div class="status-item">
    <div class="status-icon">â¤ï¸</div>
    <div class="status-content">
      <div class="status-label">Health</div>
      <div class="status-bar">
        <div class="status-bar-fill health" id="health-bar"></div>
        <div class="status-value" id="health-value">100%</div>
      </div>
    </div>
  </div>

  <div class="status-item">
    <div class="status-icon">âš¡</div>
    <div class="status-content">
      <div class="status-label">Energy</div>
      <div class="status-bar">
        <div class="status-bar-fill energy" id="energy-bar"></div>
        <div class="status-value" id="energy-value">100%</div>
      </div>
    </div>
  </div>

  <div class="status-item">
    <div class="status-icon">ğŸ–</div>
    <div class="status-content">
      <div class="status-label">Hunger</div>
      <div class="status-bar">
        <div class="status-bar-fill hunger" id="hunger-bar"></div>
        <div class="status-value" id="hunger-value">100%</div>
      </div>
    </div>
  </div>
</div>

<script>
// å…³é—­èœå•çš„å…¨å±€å‡½æ•°
function closeDogMenu() {
  const menu = document.getElementById('dog-status-menu');
  menu.classList.remove('show');
}

(function() {
  const dog = document.getElementById('fish-follower');
  const dogSprite = dog.querySelector('.dog-sprite');
  const statusMenu = document.getElementById('dog-status-menu');
  const dogHouseButton = document.getElementById('dog-house-button');

  let dogX = -100;
  let dogY = -100;
  let targetX = -100;
  let targetY = -100;
  let smoothness = 0.1;
  let lastDx = 0;
  let lastDy = 0;
  let isDogOut = false; // è®°å½•å°ç‹—æ˜¯å¦åœ¨å¤–é¢

  // ç‹—ç‹—çŠ¶æ€æ•°æ®
  let dogStatus = {
    mood: 100,
    health: 100,
    energy: 100,
    hunger: 100
  };

  document.addEventListener('mousemove', function(e) {
    targetX = e.clientX;
    targetY = e.clientY;
  });

  function animate() {
    const dx = targetX - dogX;
    const dy = targetY - dogY;
    const distance = Math.sqrt(dx * dx + dy * dy);

    const IDLE_DISTANCE = 30;
    const WALK_DISTANCE = 150;
    const RUN_DISTANCE = 400;

    if (distance < IDLE_DISTANCE) {
      smoothness = 0.003;
    } else if (distance < WALK_DISTANCE) {
      smoothness = 0.008;
    } else if (distance < RUN_DISTANCE) {
      smoothness = 0.015;
    } else {
      smoothness = 0.025;
    }

    dogX += dx * smoothness;
    dogY += dy * smoothness;

    dog.style.left = (dogX - 32) + 'px';
    dog.style.top = (dogY - 32) + 'px';

    if (distance < IDLE_DISTANCE) {
      dogSprite.classList.remove('running', 'jumping');
      dogSprite.classList.add('idle');
    } else if (distance < WALK_DISTANCE) {
      dogSprite.classList.remove('idle', 'jumping');
      dogSprite.classList.add('running');
      dogSprite.style.animationDuration = '0.8s';
    } else if (distance < RUN_DISTANCE) {
      dogSprite.classList.remove('idle', 'jumping');
      dogSprite.classList.add('running');
      dogSprite.style.animationDuration = '0.5s';
    } else {
      dogSprite.classList.remove('idle', 'running');
      dogSprite.classList.add('jumping');
    }

    if (distance > 3) {
      dog.classList.remove('facing-left', 'facing-right', 'facing-up', 'facing-down');

      if (Math.abs(dx) > 2) {
        if (dx > 0) {
          dog.classList.add('facing-right');
        } else {
          dog.classList.add('facing-left');
        }
      } else {
        if (lastDx > 0) {
          dog.classList.add('facing-right');
        } else {
          dog.classList.add('facing-left');
        }
      }

      if (Math.abs(dy) > Math.abs(dx) * 0.4) {
        if (dy < 0) {
          dog.classList.add('facing-up');
        } else if (dy > 0) {
          dog.classList.add('facing-down');
        }
      }

      lastDx = dx;
      lastDy = dy;
    }

    requestAnimationFrame(animate);
  }

  animate();

  window.addEventListener('load', function() {
    dogX = window.innerWidth / 2;
    dogY = window.innerHeight / 2;
  });

  // ç‹—çªæŒ‰é’®ç‚¹å‡»äº‹ä»¶ - åˆ‡æ¢å°ç‹—æ˜¾ç¤º/éšè—
  dogHouseButton.addEventListener('click', function(e) {
    e.stopPropagation();

    if (isDogOut) {
      // æ”¶å›å°ç‹—
      isDogOut = false;
      dog.style.display = 'none';
      dogHouseButton.classList.remove('has-dog');
      dogHouseButton.textContent = 'Release';

      // å…³é—­çŠ¶æ€èœå•
      statusMenu.classList.remove('show');
    } else {
      // æ”¾å‡ºå°ç‹—
      isDogOut = true;
      dog.style.display = 'block';
      dogHouseButton.classList.add('has-dog');
      dogHouseButton.textContent = 'Recall';

      // è·å–ç‹—çªæŒ‰é’®çš„ä½ç½®ä½œä¸ºå°ç‹—çš„åˆå§‹ä½ç½®
      const buttonRect = dogHouseButton.getBoundingClientRect();
      dogX = buttonRect.left + buttonRect.width / 2;
      dogY = buttonRect.top + buttonRect.height / 2;
      targetX = dogX;
      targetY = dogY;

      // ç«‹å³æ›´æ–°å°ç‹—ä½ç½®
      dog.style.left = (dogX - 32) + 'px';
      dog.style.top = (dogY - 32) + 'px';
    }
  });

  // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
  function updateStatusDisplay() {
    document.getElementById('mood-bar').style.width = dogStatus.mood + '%';
    document.getElementById('mood-value').textContent = Math.round(dogStatus.mood) + '%';

    document.getElementById('health-bar').style.width = dogStatus.health + '%';
    document.getElementById('health-value').textContent = Math.round(dogStatus.health) + '%';

    document.getElementById('energy-bar').style.width = dogStatus.energy + '%';
    document.getElementById('energy-value').textContent = Math.round(dogStatus.energy) + '%';

    document.getElementById('hunger-bar').style.width = dogStatus.hunger + '%';
    document.getElementById('hunger-value').textContent = Math.round(dogStatus.hunger) + '%';
  }

  // ç‚¹å‡»ç‹—ç‹—æ˜¾ç¤ºçŠ¶æ€èœå•å¹¶å¢åŠ å¿ƒæƒ…å’Œé¥±è…¹åº¦ï¼ˆäº’åŠ¨å–‚é£Ÿï¼‰
  dogSprite.addEventListener('click', function(e) {
    e.stopPropagation();

    // å¢åŠ å¿ƒæƒ…å’Œé¥±è…¹åº¦
    dogStatus.mood = Math.min(100, dogStatus.mood + 5);
    dogStatus.hunger = Math.min(100, dogStatus.hunger + 3);

    // åˆ‡æ¢èœå•æ˜¾ç¤º
    if (statusMenu.classList.contains('show')) {
      statusMenu.classList.remove('show');
    } else {
      // è®¡ç®—èœå•ä½ç½®ï¼ˆåœ¨ç‹—ç‹—æ—è¾¹ï¼‰
      const menuWidth = 280;
      const menuHeight = 300;
      let menuX = dogX + 40;
      let menuY = dogY - 150;

      // ç¡®ä¿èœå•ä¸è¶…å‡ºå±å¹•
      if (menuX + menuWidth > window.innerWidth) {
        menuX = dogX - menuWidth - 40;
      }
      if (menuY < 10) {
        menuY = 10;
      }
      if (menuY + menuHeight > window.innerHeight) {
        menuY = window.innerHeight - menuHeight - 10;
      }

      statusMenu.style.left = menuX + 'px';
      statusMenu.style.top = menuY + 'px';

      // æ›´æ–°æ˜¾ç¤ºå¹¶æ˜¾ç¤ºèœå•
      updateStatusDisplay();
      statusMenu.classList.add('show');
    }
  });

  // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
  document.addEventListener('click', function(e) {
    if (!statusMenu.contains(e.target) && e.target !== dogSprite) {
      statusMenu.classList.remove('show');
    }
  });

  // çŠ¶æ€éšæ—¶é—´è‡ªç„¶å˜åŒ–ï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
  setInterval(function() {
    // èƒ½é‡ç¼“æ…¢ä¸‹é™
    dogStatus.energy = Math.max(0, dogStatus.energy - 0.05);

    // é¥±è…¹åº¦ç¼“æ…¢ä¸‹é™
    dogStatus.hunger = Math.max(0, dogStatus.hunger - 0.03);

    // æ ¹æ®é¥±è…¹åº¦å’Œèƒ½é‡å½±å“å¿ƒæƒ…
    if (dogStatus.hunger < 30 || dogStatus.energy < 30) {
      dogStatus.mood = Math.max(0, dogStatus.mood - 0.1);
    } else if (dogStatus.hunger > 70 && dogStatus.energy > 70) {
      dogStatus.mood = Math.min(100, dogStatus.mood + 0.2);
    }

    // æ ¹æ®å¿ƒæƒ…å½±å“å¥åº·
    if (dogStatus.mood < 50) {
      dogStatus.health = Math.max(0, dogStatus.health - 0.02);
    } else if (dogStatus.mood > 80) {
      dogStatus.health = Math.min(100, dogStatus.health + 0.05);
    }

    // å¦‚æœèœå•æ‰“å¼€ï¼Œå®æ—¶æ›´æ–°æ˜¾ç¤º
    if (statusMenu.classList.contains('show')) {
      updateStatusDisplay();
    }
  }, 1000);

  // é¼ æ ‡ç§»åŠ¨å¢åŠ èƒ½é‡ï¼ˆè¿½é€æ¸¸æˆï¼‰
  let lastMoveTime = Date.now();
  document.addEventListener('mousemove', function() {
    const now = Date.now();
    if (now - lastMoveTime > 100) {
      // æ¯æ¬¡ç§»åŠ¨é¼ æ ‡ï¼Œå¦‚æœç‹—ç‹—åœ¨è¿½é€ï¼Œæ¢å¤å°‘é‡èƒ½é‡
      const distance = Math.sqrt(Math.pow(targetX - dogX, 2) + Math.pow(targetY - dogY, 2));
      if (distance > 50) {
        dogStatus.energy = Math.min(100, dogStatus.energy + 0.01);
      }
      lastMoveTime = now;
    }
  });
})();
</script>
